pipeline {
    agent any

    environment {
        DOCKERHUB_CREDENTIALS = 'dckr_pat_CsXPstyoY9Wo-iTLwnU8XonrYx4' // Replace with your Docker Hub credentials ID
        DOCKERHUB_REPO = 'luffymonkey1/shop-app' // Replace with your Docker Hub repository name
    }

    stages {
        stage('Clone Repository') {
            steps {
                git credentialsId: 'GitHub', url: 'https://github.com/cyb-swap/shop-app.git'
            }
        }

        stage('Dependency-Check') {
            steps {
                dependencyCheck additionalArguments: '--nvdApiKey 2a6b167d-8721-4fd6-878c-dc4a156434f7', odcInstallation: 'dep-check-auto'
                dependencyCheckPublisher pattern: ''
                archiveArtifacts allowEmptyArchive: true, artifacts: 'dependency-check-report.xml', fingerprint: true, followSymlinks: false, onlyIfSuccessful: true
                sh ' rm -rf dependency-check-report.xml*'
            }
        }
        
        stage('Build Docker Images') {
            steps {
                script {
                    def images = [
                        ["name": "shop_app_app:latest", "path": "app"],
                        ["name": "shop_app_database:latest", "path": "database"],
                        ["name": "shop_app_payment_gateway:latest", "path": "payment_gateway"],
                        ["name": "shop_app_reverse_proxy:latest", "path": "reverse_proxy"]
                    ]
                    
                    for (img in images) {
                        echo "Building Docker image: ${img.name}"
                        docker.build(img.name, img.path)
                    }
                }
            }
        }

        stage('Container Security') {
            steps {
                script {
                    try {
                        // Run the grype scan and redirect output to grype.txt
                        sh 'grype vulnerables/web-dvwa:latest > grype.txt'
                
                        // Archive the grype output regardless of success
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'grype.txt', fingerprint: true, followSymlinks: false
                
                        // Optionally read the vulnerabilities from the output file
                        def vulnerabilities = readFile('grype.txt')
                        echo "Grype Scan Output:\n${vulnerabilities}"
                
                        // Check if vulnerabilities were found and fail the build if necessary
                        if (vulnerabilities.contains('vulnerable')) {
                        error("Vulnerabilities found in vulnerables/web-dvwa:latest!")
                        }
                
                    } catch (Exception e) {
                        // Catch the exception and echo the error message
                        echo "Grype scan failed: ${e.message}"
                
                        // Archive the output even if the grype command fails
                        archiveArtifacts allowEmptyArchive: true, artifacts: 'grype.txt', fingerprint: true, followSymlinks: false
                
                        // Optionally fail the build or handle the error
                        currentBuild.result = 'UNSTABLE' // Mark the build as unstable
                    } finally {
                        // Cleanup the output file after processing
                        sh 'rm -rf grype.txt'
                    }
                }
            }
        }        
         
        stage('SCA') {
            steps {
                script{
                    dir('app/react-app') {
                        sh 'yarn install'
                        snykSecurity(
                            snykInstallation: 'snyk',
                            snykTokenId: '59e68e07-6d49-416b-a4f3-ba4523a0f631',
                            failOnIssues: false,
                        )
                    }
                }
            }
        }

        stage('Push Docker Images to Docker Hub') {
            steps {
                script {
                    // Login to Docker Hub
                    docker.withRegistry('https://index.docker.io/v1/', DOCKERHUB_CREDENTIALS) {
                        // Push the built images to Docker Hub
                        def images = [
                            "${DOCKERHUB_REPO}/shop_app_app:latest",
                            "${DOCKERHUB_REPO}/shop_app_database:latest",
                            "${DOCKERHUB_REPO}/shop_app_payment_gateway:latest",
                            "${DOCKERHUB_REPO}/shop_app_reverse_proxy:latest"
                        ]
                        
                        for (img in images) {
                            echo "Pushing Docker image: ${img}"
                            docker.image(img).push()
                        }
                    }
                }
            }
        }
        
        stage('Run Docker Compose') {
            steps {
                script {
                    sh 'docker-compose up -d'
                }
            }
        }
    }
    
    post {
        always {
            script {
                sh 'docker-compose down'
            }
            cleanWs()
        }
    }
}
